upstream appcluster {
  <% @upstream_servers.each do |upstream_server| -%>
   server <%= upstream_server.has_key?("ec2") ? upstream_server["ec2"]["hostname"] : upstream_server["ipaddress"] %>:<%= @port %>;
  <% end -%>
}

server {
   listen 80;
   server_name <%=@envName%>.proversity.com;
   rewrite ^/(.*) https://$server_name/$1 permanent;
}

server {
  listen 443;
  listen 80;

  server_name load_balancer_test;
  ssl on;
  ssl_certificate <%=@certInstallDir%>/server.crt;
  ssl_certificate_key <%=@keyInstallDir%>/server.key;

  ssl_session_cache   shared:SSL:10m;
  ssl_session_timeout 10m;
  ssl_protocols SSLv3 TLSv1;
  ssl_ciphers ALL:!ADH:!EXPORT56:RC4+RSA:+HIGH:+MEDIUM:+LOW:+SSLv3:+EXP;
  ssl_prefer_server_ciphers on;
  client_max_body_size 200M;
  
  root   <%=@install_dir%>/<%=@appName%>;

  location /handleWebSocketRequest {
             proxy_pass http://appcluster/handleWebSocketRequest;
             proxy_http_version 1.1;
             proxy_set_header Upgrade $http_upgrade;
             proxy_set_header Connection "upgrade";
             proxy_read_timeout 8m;
            # proxy_set_header        X-Real-IP $remote_addr;
            # proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            # proxy_set_header        Host $http_host;

        }

        location /v1 {
            proxy_pass http://appcluster/v1;
            proxy_set_header        X-Real-IP $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header        Host $http_host;
            proxy_read_timeout 8m;

        }

	location /zencn {
            proxy_pass http://appcluster/zencn;
            proxy_set_header        X-Real-IP $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header        Host $http_host;
            proxy_read_timeout 8m;

        }

	location /upload/file {
            proxy_pass http://appcluster/upload/file;
            proxy_set_header        X-Real-IP $remote_addr;
            proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header        Host $http_host;
            proxy_read_timeout 8m;

        }

	location / {
            		index  index.html index.htm;
					error_page 405 = $uri;
					proxy_set_header X-Forwarded-Protocol "http" ;
          			try_files $uri @prerender;
        	}
        	
	location @prerender {
        			proxy_set_header X-Prerender-Token 5RM8OgTVkL7bD30lsIpy;
        
        			set $prerender 0;
        			if ($http_user_agent ~* "baiduspider|twitterbot|facebookexternalhit") {
            			set $prerender 1;
        			}
        			if ($args ~ "_escaped_fragment_") {
            			set $prerender 1;
        			}
        			if ($http_user_agent ~ "Prerender") {
            			set $prerender 0;
        			}
        			if ($uri ~ "\.(js|css|xml|less|png|jpg|jpeg|gif|pdf|doc|txt|ico|rss|zip|mp3|rar|exe|wmv|doc|avi|ppt|mpg|mpeg|tif|wav|mov|psd|ai|xls|mp4|m4a|swf|dat|dmg|iso|flv|m4v|torrent)") {
          				set $prerender 0;
        			}
 
        			if ($prerender = 1) {
            			rewrite .* /$scheme://<%=@envName%>.proversity.com$request_uri? break;
            			proxy_pass http://service.prerender.io;
        			}
        			if ($prerender = 0) {
            			rewrite .* /index.html break;
        			}
    }        	
}
